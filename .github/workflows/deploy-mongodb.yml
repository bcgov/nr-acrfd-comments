name: Deploy MongoDB with Helm

on:
  push:
    branches:
      - main
    paths:
      - "helm/mongodb/**"
      - ".github/workflows/deploy-mongodb.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - test
          - prod

env:
  REGISTRY: image-registry.openshift-image-registry.svc:5000

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, test, prod]
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Create MongoDB Secret
        run: |
          NAMESPACE=${{ secrets.OPENSHIFT_NAMESPACE }}

          # Create or update the Secret with credentials
          # Using --dry-run and apply for idempotent creation
          kubectl create secret generic mongodb-secret \
            -n $NAMESPACE \
            --from-literal=mongodb-password='${{ secrets.MONGODB_PASSWORD }}' \
            --from-literal=mongodb-admin-password='${{ secrets.MONGODB_ADMIN_PASSWORD }}' \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Secret 'mongodb-secret' created/updated"

          # Verify Secret was created
          kubectl get secret mongodb-secret -n $NAMESPACE

      - name: Deploy MongoDB StatefulSet
        run: |
          ENVIRONMENT=${{ matrix.environment }}
          NAMESPACE=${{ secrets.OPENSHIFT_NAMESPACE }}

          # Check if PVC exists (safety check)
          if ! kubectl get pvc mongodbdata -n $NAMESPACE &>/dev/null; then
            echo "ERROR: PVC 'mongodbdata' not found in namespace $NAMESPACE"
            echo "Please ensure the PVC exists before deploying the StatefulSet"
            exit 1
          fi

          echo "PVC 'mongodbdata' found. Proceeding with deployment..."

          # Deploy or upgrade MongoDB StatefulSet
          helm upgrade --install mongodb ./helm/mongodb \
            --namespace $NAMESPACE \
            --values ./helm/mongodb/values-$ENVIRONMENT.yaml \
            --wait \
            --timeout 5m

      - name: Verify MongoDB StatefulSet
        run: |
          NAMESPACE=${{ secrets.OPENSHIFT_NAMESPACE }}

          # Wait for StatefulSet to be ready
          kubectl rollout status statefulset mongodb -n $NAMESPACE --timeout=5m

          # Check pod status
          kubectl get statefulset mongodb -n $NAMESPACE
          kubectl get pods -l app.kubernetes.io/name=mongodb -n $NAMESPACE

      - name: Test MongoDB Connection
        run: |
          NAMESPACE=${{ secrets.OPENSHIFT_NAMESPACE }}

          # Test connection to MongoDB
          kubectl exec mongodb-0 -n $NAMESPACE -- \
            mongo 127.0.0.1:27017 --eval "db.adminCommand('ping')" || true

          echo "MongoDB is ready for connections"

      - name: Check Data Integrity
        run: |
          NAMESPACE=${{ secrets.OPENSHIFT_NAMESPACE }}

          # Count documents in applications collection (optional)
          kubectl exec mongodb-0 -n $NAMESPACE -- \
            mongo 127.0.0.1:27017/prc-${{ matrix.environment }} \
            -u user54L \
            --eval "print('Document count: ' + db.applications.count())" || true

      - name: Deployment Summary
        if: success()
        run: |
          echo "✅ MongoDB StatefulSet deployed successfully to ${{ matrix.environment }}"
          echo ""
          echo "Deployment Details:"
          kubectl get statefulset mongodb -n ${{ secrets.OPENSHIFT_NAMESPACE }} -o wide
          echo ""
          echo "Pod Status:"
          kubectl get pods mongodb-0 -n ${{ secrets.OPENSHIFT_NAMESPACE }}
          echo ""
          echo "Service:"
          kubectl get svc mongodb -n ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "❌ Deployment failed. Checking previous status..."
          kubectl rollout history statefulset mongodb -n ${{ secrets.OPENSHIFT_NAMESPACE }}
          echo ""
          echo "To rollback to previous version:"
          echo "kubectl rollout undo statefulset mongodb -n ${{ secrets.OPENSHIFT_NAMESPACE }}"
