# Reusable vars
x-var:
  - &MONGODB_USER admin
  - &MONGODB_PASSWORD nrts-dev
  - &MONGODB_DATABASE nrts-dev
  - &node-image node:22

# Reusable envars for MongoDB
x-mongodb-vars: &mongodb-vars
  MONGODB_SERVICE_HOST: database
  MONGODB_USERNAME: *MONGODB_USER
  MONGODB_PASSWORD: *MONGODB_PASSWORD
  MONGODB_DATABASE: *MONGODB_DATABASE
  DB_1_PORT_27017_TCP_ADDR: database

services:
  database:
    image: mongo:7
    container_name: database
    environment:
      MONGO_INITDB_ROOT_USERNAME: *MONGODB_USER
      MONGO_INITDB_ROOT_PASSWORD: *MONGODB_PASSWORD
      MONGO_INITDB_DATABASE: *MONGODB_DATABASE
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports: ["27017:27017"]
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js

  backend:
    container_name: backend
    depends_on:
      database:
        condition: service_healthy
    build: ./backend
    environment:
      <<: *mongodb-vars
      NODE_ENV: development
      API_HOSTNAME: localhost:3000
      KEYCLOAK_ENABLED: ${KEYCLOAK_ENABLED:-false}
      SECRET: ${SECRET:-defaultSecret}
      SSO_ISSUER: ${SSO_ISSUER:-https://dev.oidc.gov.bc.ca/auth/realms/prc}
      SSO_JWKSURI: ${SSO_JWKSURI:-https://dev.oidc.gov.bc.ca/auth/realms/prc/protocol/openid-connect/certs}
    ports: ["3001:3000"]
    working_dir: "/app"
    volumes:
      - ./backend:/app
      - /app/node_modules
    command: npm start

  frontend-admin:
    container_name: frontend-admin
    depends_on:
      - backend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      BACKEND_URL: http://backend:3000
    ports: ["4200:4200"]
    working_dir: "/app"
    volumes:
      - ./frontend/admin:/app/admin

  frontend-public:
    container_name: frontend-public
    depends_on:
      - backend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      BACKEND_URL: http://backend:3000
    ports: ["3000:3000"]
    working_dir: "/app"
    volumes:
      - ./frontend/public:/app/public

volumes:
  mongodb_data:
